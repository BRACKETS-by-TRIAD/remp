<template>
    <div class="ab-testing">
        <div class="row">
            <div class="col-md-12">

                <div id="slider" class="m-b-25 m-t-25"></div>

                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>&nbsp;</th>
                            <th>Variant name</th>
                            <th>Banner</th>
                            <th>&nbsp;</th>
                            <th>&nbsp;</th>
                        </tr>
                    </thead>

                    <tbody>
                        <tr v-for="(variant, index) in variants" :key="variant.value">

                            <!-- variant color box -->
                            <td class="table-td-color" :class="['color-' + index]"><div></div></td>

                            <!-- variant name -->
                            <td class="table-td-name">
                                <input type="text" :name="'variants[' + index + '][name]'" v-model="variant.name" :disabled="variant.control_group == 1">
                            </td>

                            <!-- variant select -->
                            <td class="table-td-banner">
                                <v-select id="variant_id"
                                        :name="'variants[' + index + '][id]'"
                                        :value="variant.id"
                                        :title="'No alternative'"
                                        :options.sync="variantOptions"
                                        v-if="index != variants.length - 1 && index != 0"
                                ></v-select>
                                <span v-if="index == 0" title="This banner can be changed only in previous step.">{{ $parent.variantOptions[variants[index].id].label }}</span>
                            </td>

                            <!-- proportion value -->
                            <td style="text-align: right;">
                                <input type="number" :class="['ab-testing-input', 'ab-testing-input-' + index]" name="asd" :value="variant.val" @change="handleInputUpdate(this.event, index)" id="">&nbsp;&nbsp;%
                            </td>

                            <!-- remove variant button -->
                            <td class="table-td-button">
                                <button @click="removeVariant($event, index)">
                                    <i class="zmdi zmdi-minus-circle"></i>
                                </button>
                            </td>

                            <!-- add variant button -->
                            <td class="table-td-button">
                                <button v-if="index == variants.length - 1" class="pull-right" @click="addEmptyVariant($event, index)">
                                    <i class="zmdi zmdi-plus-circle"></i>
                                </button>
                            </td>

                        </tr>
                    </tbody>
                </table>

            </div>
        </div><!-- .row -->

    </div>
</template>

<script type="text/javascript">
    import vSelect from "remp/js/components/vSelect";

    export default {
        components: {
            vSelect
        },
        props: {
            variantOptions: null,
            variants: {
                default: [
                    {
                        name: "Variant B",
                        val: 30
                    }
                ]
            }
        },
        data() {
            return {
                sliderEl: null,
                dontRunSliderUpdate: true
            };
        },
        created() {
            if (!this.variants.length) {
                this.addEmptyVariant();
            }
        },
        mounted() {
            var starts  = [],
                sum     = 0;

            // create slider handle starts from variants data
            for(var ii = 0; ii < this.variants.length - 1; ii++) {
                sum += this.variants[ii].proportion;
                starts.push(sum);
            }

            // create slider
            this.sliderEl = document.getElementById('slider');
            noUiSlider.create(this.sliderEl, {
                start: starts,
                range: {
                    min: 0,
                    max: 100
                },
                step: 1,
                connect: Array(this.variants.length).fill(true)
            });

            // set slider connects color
            var connects = slider.querySelectorAll('.noUi-connect');

            for (var i = 0; i < connects.length; i++) {
                connects[i].classList.add('color-' + i);
            }

            // bind events
            this.sliderEl.noUiSlider.on('update', this.handleSliderUpdate);
        },
        methods: {
            handleSliderUpdate(values, handle) {
                var sum = 0;

                console.log(this.variants);

                for (var ii = 0; ii < values.length; ii++) {
                    var val = parseInt(values[ii]);

                    if (ii == 0) {
                        this.variants[ii].proportion = val;
                        sum += val;
                    } else {
                        this.variants[ii].proportion = parseInt(val-values[ii-1]);
                        sum += parseInt(val-values[ii-1]);
                    }
                }

                this.variants[this.variants.length-1].proportion = 100-sum;


            },
            handleInputUpdate(event, i) {
                var a = Array(this.variants.length).fill(null),
                    prevInputsSum = 0,
                    sum = 0;


                // sum all previous inputs & all inputs
                for(var ii = 0; ii < this.variants.length; ii++) {
                    var els = document.getElementsByClassName('ab-testing-input-' + ii);

                    if (els.length) {
                        sum += parseInt(els[0].value)
                        prevInputsSum += (ii < i) ? parseInt(els[0].value) : 0;
                    }
                }

                // handle control group input
                if (this.variants.length - 1 === i) {
                    a[i-1] = prevInputsSum + (100 - prevInputsSum - parseInt(event.srcElement.value));

                // handle regular variant input
                } else {
                    a[i] = prevInputsSum+parseInt(event.srcElement.value)
                }

                this.sliderEl.noUiSlider.set(a)
            },
            addEmptyVariant: function (event, index) {
                this.variants.push({
                    'id': null,
                    'name': "Variant" + index
                });

                if (event) {
                    event.preventDefault();
                }
            },
            removeVariant: function (i) {
                let toRemove = this.variants[i]
                this.variants.splice(i, 1);
                this.removedVariants.push(toRemove.id);
            }
        },
        watch: {
            variants: {
                proportion: function () {
                    console.log('proportion changed')
                }
            }
        }
    }
</script>

<style>
.ab-testing {
    padding: 20px 40px;
}

.ab-testing-input {
    max-width: 40px;
    text-align: center;
}

.table-td-color {
    width: 20px;
}

.table-td-color > div {
    width: 20px;
    height: 20px;
}

.noUi-connect.color-0,
.table-td-color.color-0 > div {
    background: #E37B40;
}

.noUi-connect.color-1,
.table-td-color.color-1 > div {
    background: #46B29D;
}

.noUi-connect.color-2,
.table-td-color.color-2 > div {
    background: #DE5B49;
}

.noUi-connect.color-3,
.table-td-color.color-3 > div {
    background: #324D5C;
}

.noUi-connect.color-4,
.table-td-color.color-4 > div {
    background: #F0CA4D;
}


.table-td-button {
    width: 27px;
}


.table > tbody > tr > td:first-child {
    padding-left: 20px;
}

.table > tbody > tr > td:last-child {
    padding-right: 20px;
}

.table > tbody > tr:last-child > td, .table > tfoot > tr:last-child > td {
    padding-bottom: 15px;
}

html input[disabled] {
    background: none;
    border: none;
}
</style>

