# Mailer

## Admin (Nette)

Mailer Admin serves as a tool for configuration of mailers, creation of email layouts and
templates, and configuring and sending mail jobs to selected segments of users.

When the backend is ready, don't forget to install dependencies and run DB migrations:

```bash
# 1. Download PHP dependencies
composer install

# 2. Download JS/HTML dependencies
yarn install

# !. use extra switch if your system doesn't support symlinks (Windows; can be enabled)
yarn install --no-bin-links

# 3. Generate assets
yarn run dev // or any other alternative defined within package.json

# 4. Run migrations
php bin/command.php migrate:migrate

# 5. Run seeders
php bin/command.php db:seed
php bin/command.php demo:seed # optional
```

You can override any default config from
[`config.neon`](./app/config/config.neon) by creating file 
`config.local.neon` and setting your own values.

#### Dependencies

- PHP 7.1
- MySQL 5.7
- Redis 3.2

### Integration with user base

Mailer is dependent on external user base and segment provider. After the installation the application uses dummy
implementations `Remp\MailerModule\Segment\Dummy` and `Remp\MailerModule\User\Dummy`.

To integrate with your user base, you need to implement `Remp\MailerModule\User\IUser` interface and register it
as an service within your your [`config.local.neon`](./app/config/config_local.neon).

You can check our reference implementation against our user base in
[`Remp\MailerModule\User\Crm`](./app/models/Users/Crm.php) and against our segment API in
[`Remp\MailerModule\Segment\Crm`](./app/models/Segments/Crm.php) or
[`Remp\MailerModule\Segment\Remp`](./app/models/Segments/Remp.php). 

### Mailers

By default application includes implementation of:

- [SmtpMailer](./app/models/Mailers/SmtpMailer.php)
- [MailgunMailer](./app/models/Mailers/SmtpMailer.php).

To switch to your implementation, make sure your class implements `Nette\Mail\IMailer`
interface and override *mailFactory* section within your `config_local.neon`.

### Workers

For application to function properly, you need to run several backend workers handling
email-sending related tasks.

We recommend to use Systemd or Supervisord for handling them.

To list all available console commands, run `php bin/command.php`.

- **worker:hermes**: Handler of all asynchronous events generated by application.
- **worker:mail**: Handler responsible for actual sending of emails via configured mailer.
- **worker:subscribe**: Handler responsible for subscribing new users to emails with
auto-subscription enabled. It listens for `user_register` event from Kafka
(generated by Beam Tracker).
- **worker:change-email**: Handler managing events of users changing their emails. 
It removes original subscriptions and subscribes user to the new email address. It listens for
`email_changed` event from Kafka (generated by Beam Tracker).
